import { useState, useEffect, useRef } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription } from '@/components/ui/dialog';
import { ScrollArea } from '@/components/ui/scroll-area';
import { Bug, Search, Play, Code, Database, Shield, Zap, Terminal, Package, AlertTriangle, CheckCircle2, X, Square, Server } from 'lucide-react';

const exploitModules = [
  { id: 1, name: 'apache_struts_rce', category: 'exploit', platform: 'multi', rating: 'excellent', cve: 'CVE-2023-50164', verified: true },
  { id: 2, name: 'log4j_jndi_injection', category: 'exploit', platform: 'java', rating: 'excellent', cve: 'CVE-2021-44228', verified: true },
  { id: 3, name: 'spring4shell_rce', category: 'exploit', platform: 'java', rating: 'great', cve: 'CVE-2022-22965', verified: true },
  { id: 4, name: 'smb_ms17_010', category: 'exploit', platform: 'windows', rating: 'excellent', cve: 'CVE-2017-0144', verified: true },
  { id: 5, name: 'sudo_baron_samedit', category: 'exploit', platform: 'linux', rating: 'great', cve: 'CVE-2021-3156', verified: true },
  { id: 6, name: 'proxyshell_exchange', category: 'exploit', platform: 'windows', rating: 'good', cve: 'CVE-2021-34473', verified: false },
];

const payloads = [
  { name: 'meterpreter/reverse_tcp', type: 'staged', arch: 'x86/x64', platform: 'windows' },
  { name: 'shell/reverse_tcp', type: 'singles', arch: 'x86/x64', platform: 'multi' },
  { name: 'python/meterpreter/reverse_https', type: 'staged', arch: 'python', platform: 'multi' },
  { name: 'cmd/unix/reverse_bash', type: 'singles', arch: 'cmd', platform: 'unix' },
];

const activeSessions = [
  { id: 1, type: 'meterpreter', target: '192.168.1.105', user: 'SYSTEM', platform: 'Windows 10', status: 'active' },
  { id: 2, type: 'shell', target: '10.0.0.45', user: 'root', platform: 'Ubuntu 22.04', status: 'active' },
  { id: 3, type: 'meterpreter', target: '172.16.0.23', user: 'admin', platform: 'Windows Server 2019', status: 'idle' },
];

const availableTargets = [
  { id: 1, ip: '192.168.1.105', hostname: 'WIN-PC01', os: 'Windows 10', ports: [80, 443, 445, 3389] },
  { id: 2, ip: '10.0.0.45', hostname: 'ubuntu-web01', os: 'Ubuntu 22.04', ports: [22, 80, 443, 8080] },
  { id: 3, ip: '172.16.0.23', hostname: 'DC-PRIMARY', os: 'Windows Server 2019', ports: [53, 88, 135, 389, 445] },
  { id: 4, ip: '192.168.1.200', hostname: 'apache-prod', os: 'CentOS 7', ports: [22, 80, 443, 8443] },
  { id: 5, ip: '10.0.0.100', hostname: 'java-app01', os: 'Debian 11', ports: [22, 8080, 8443, 9000] },
];

const ratingColors = {
  excellent: 'bg-success/20 text-success',
  great: 'bg-primary/20 text-primary',
  good: 'bg-warning/20 text-warning',
  normal: 'bg-muted text-muted-foreground',
};

interface ConsoleOutput {
  type: 'info' | 'success' | 'error' | 'warning' | 'command';
  text: string;
  timestamp: Date;
}

export default function ExploitFramework() {
  const [searchQuery, setSearchQuery] = useState('');
  const [activeTab, setActiveTab] = useState('exploits');
  const [showConsole, setShowConsole] = useState(false);
  const [selectedExploit, setSelectedExploit] = useState<typeof exploitModules[0] | null>(null);
  const [selectedTarget, setSelectedTarget] = useState<string>('');
  const [selectedPayload, setSelectedPayload] = useState<string>('');
  const [isRunning, setIsRunning] = useState(false);
  const [consoleOutput, setConsoleOutput] = useState<ConsoleOutput[]>([]);
  const consoleEndRef = useRef<HTMLDivElement>(null);

  const filteredExploits = exploitModules.filter(exploit =>
    exploit.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
    exploit.cve.toLowerCase().includes(searchQuery.toLowerCase())
  );

  useEffect(() => {
    consoleEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [consoleOutput]);

  const addOutput = (type: ConsoleOutput['type'], text: string) => {
    setConsoleOutput(prev => [...prev, { type, text, timestamp: new Date() }]);
  };

  const simulateExploit = async () => {
    if (!selectedExploit || !selectedTarget || !selectedPayload) return;
    
    const target = availableTargets.find(t => t.id.toString() === selectedTarget);
    if (!target) return;

    setIsRunning(true);
    setConsoleOutput([]);

    const delay = (ms: number) => new Promise(resolve => setTimeout(resolve, ms));

    addOutput('command', `msf6 > use exploit/${selectedExploit.name}`);
    await delay(300);
    addOutput('info', `[*] Using configured payload ${selectedPayload}`);
    await delay(200);

    addOutput('command', `msf6 exploit(${selectedExploit.name}) > set RHOSTS ${target.ip}`);
    await delay(200);
    addOutput('info', `RHOSTS => ${target.ip}`);
    await delay(150);

    addOutput('command', `msf6 exploit(${selectedExploit.name}) > set LHOST 10.10.14.5`);
    await delay(200);
    addOutput('info', `LHOST => 10.10.14.5`);
    await delay(150);

    addOutput('command', `msf6 exploit(${selectedExploit.name}) > exploit`);
    await delay(500);

    addOutput('info', `[*] Started reverse TCP handler on 10.10.14.5:4444`);
    await delay(800);
    addOutput('info', `[*] Connecting to ${target.ip}:${target.ports[0]}...`);
    await delay(600);
    addOutput('info', `[*] Scanning target for ${selectedExploit.cve} vulnerability...`);
    await delay(1200);

    // Simulate success or failure randomly (80% success rate)
    const isSuccess = Math.random() > 0.2;

    if (isSuccess) {
      addOutput('success', `[+] ${target.ip}:${target.ports[0]} - Target appears vulnerable!`);
      await delay(400);
      addOutput('info', `[*] Sending exploit payload...`);
      await delay(800);
      addOutput('info', `[*] Payload sent successfully, waiting for callback...`);
      await delay(1500);
      addOutput('success', `[+] Sending stage (${Math.floor(Math.random() * 500 + 200)}KB) to ${target.ip}`);
      await delay(600);
      addOutput('success', `[*] Meterpreter session 4 opened (10.10.14.5:4444 -> ${target.ip}:49832)`);
      await delay(300);
      addOutput('success', `[+] Exploit completed successfully!`);
      await delay(200);

      // Show meterpreter prompt
      addOutput('command', `meterpreter > getuid`);
      await delay(300);
      addOutput('info', `Server username: NT AUTHORITY\\SYSTEM`);
      await delay(200);
      addOutput('command', `meterpreter > sysinfo`);
      await delay(400);
      addOutput('info', `Computer        : ${target.hostname}`);
      addOutput('info', `OS              : ${target.os} (Build 19041)`);
      addOutput('info', `Architecture    : x64`);
      addOutput('info', `System Language : en_US`);
      addOutput('info', `Meterpreter     : x64/windows`);
    } else {
      addOutput('warning', `[!] Target does not appear to be vulnerable`);
      await delay(400);
      addOutput('error', `[-] Exploit failed: Connection refused or target patched`);
      await delay(300);
      addOutput('info', `[*] Exploit completed, but no session was created.`);
    }

    setIsRunning(false);
  };

  const handleRunExploit = (exploit: typeof exploitModules[0]) => {
    setSelectedExploit(exploit);
    setShowConsole(true);
    setConsoleOutput([]);
    setSelectedTarget('');
    setSelectedPayload('');
  };

  const stopExploit = () => {
    setIsRunning(false);
    addOutput('warning', `[!] Exploit execution interrupted by user`);
    addOutput('info', `[*] Cleaning up...`);
  };

  const getOutputColor = (type: ConsoleOutput['type']) => {
    switch (type) {
      case 'success': return 'text-success';
      case 'error': return 'text-destructive';
      case 'warning': return 'text-warning';
      case 'command': return 'text-primary font-bold';
      default: return 'text-foreground/80';
    }
  };

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="p-2 bg-warning/20 rounded-lg">
            <Bug className="h-6 w-6 text-warning" />
          </div>
          <div>
            <h1 className="text-2xl font-bold">Exploit Framework</h1>
            <p className="text-muted-foreground">Manage exploits, payloads, and active sessions</p>
          </div>
        </div>
        <Button 
          className="gap-2 bg-warning hover:bg-warning/90 text-warning-foreground"
          onClick={() => setShowConsole(true)}
        >
          <Terminal className="h-4 w-4" />
          Open Console
        </Button>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <Card className="border-warning/30 bg-warning/5">
          <CardContent className="p-4">
            <div className="flex items-center gap-3">
              <Package className="h-8 w-8 text-warning" />
              <div>
                <div className="text-2xl font-bold text-warning">2,847</div>
                <p className="text-xs text-muted-foreground">Exploit Modules</p>
              </div>
            </div>
          </CardContent>
        </Card>
        <Card className="border-primary/30 bg-primary/5">
          <CardContent className="p-4">
            <div className="flex items-center gap-3">
              <Code className="h-8 w-8 text-primary" />
              <div>
                <div className="text-2xl font-bold text-primary">592</div>
                <p className="text-xs text-muted-foreground">Payloads</p>
              </div>
            </div>
          </CardContent>
        </Card>
        <Card className="border-success/30 bg-success/5">
          <CardContent className="p-4">
            <div className="flex items-center gap-3">
              <Zap className="h-8 w-8 text-success" />
              <div>
                <div className="text-2xl font-bold text-success">3</div>
                <p className="text-xs text-muted-foreground">Active Sessions</p>
              </div>
            </div>
          </CardContent>
        </Card>
        <Card className="border-destructive/30 bg-destructive/5">
          <CardContent className="p-4">
            <div className="flex items-center gap-3">
              <AlertTriangle className="h-8 w-8 text-destructive" />
              <div>
                <div className="text-2xl font-bold text-destructive">127</div>
                <p className="text-xs text-muted-foreground">0-Day Exploits</p>
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Main Content */}
      <Tabs value={activeTab} onValueChange={setActiveTab}>
        <TabsList>
          <TabsTrigger value="exploits">Exploits</TabsTrigger>
          <TabsTrigger value="payloads">Payloads</TabsTrigger>
          <TabsTrigger value="sessions">Sessions</TabsTrigger>
        </TabsList>

        <TabsContent value="exploits" className="mt-4">
          <Card className="border-border/50">
            <CardHeader className="pb-3">
              <div className="flex items-center justify-between">
                <CardTitle className="text-lg">Exploit Modules</CardTitle>
                <div className="relative w-72">
                  <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                  <Input
                    placeholder="Search by name or CVE..."
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="pl-9"
                  />
                </div>
              </div>
            </CardHeader>
            <CardContent className="p-0">
              <div className="divide-y divide-border">
                {filteredExploits.map((exploit) => (
                  <div key={exploit.id} className="flex items-center justify-between p-4 hover:bg-muted/30 transition-colors">
                    <div className="flex items-center gap-4">
                      <div className="w-10 h-10 rounded-lg bg-warning/10 flex items-center justify-center">
                        <Bug className="h-5 w-5 text-warning" />
                      </div>
                      <div>
                        <div className="flex items-center gap-2">
                          <span className="font-mono font-medium">{exploit.name}</span>
                          {exploit.verified && (
                            <CheckCircle2 className="h-4 w-4 text-success" />
                          )}
                        </div>
                        <div className="flex items-center gap-3 text-sm text-muted-foreground">
                          <Badge variant="outline" className="text-xs">{exploit.platform}</Badge>
                          <span className="font-mono">{exploit.cve}</span>
                        </div>
                      </div>
                    </div>
                    <div className="flex items-center gap-3">
                      <Badge className={ratingColors[exploit.rating as keyof typeof ratingColors]}>
                        {exploit.rating}
                      </Badge>
                      <Button 
                        variant="outline" 
                        size="sm" 
                        className="gap-1"
                        onClick={() => handleRunExploit(exploit)}
                      >
                        <Play className="h-3 w-3" />
                        Run
                      </Button>
                    </div>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="payloads" className="mt-4">
          <Card className="border-border/50">
            <CardHeader>
              <CardTitle className="text-lg">Payload Generators</CardTitle>
            </CardHeader>
            <CardContent className="p-0">
              <div className="divide-y divide-border">
                {payloads.map((payload, index) => (
                  <div key={index} className="flex items-center justify-between p-4 hover:bg-muted/30 transition-colors">
                    <div className="flex items-center gap-4">
                      <div className="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
                        <Code className="h-5 w-5 text-primary" />
                      </div>
                      <div>
                        <span className="font-mono font-medium">{payload.name}</span>
                        <div className="flex items-center gap-2 mt-1">
                          <Badge variant="outline" className="text-xs">{payload.type}</Badge>
                          <Badge variant="outline" className="text-xs">{payload.arch}</Badge>
                          <Badge variant="outline" className="text-xs">{payload.platform}</Badge>
                        </div>
                      </div>
                    </div>
                    <Button variant="outline" size="sm">Generate</Button>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        </TabsContent>

        <TabsContent value="sessions" className="mt-4">
          <Card className="border-border/50">
            <CardHeader>
              <CardTitle className="text-lg flex items-center gap-2">
                <Zap className="h-5 w-5 text-success" />
                Active Sessions
              </CardTitle>
            </CardHeader>
            <CardContent className="p-0">
              <div className="divide-y divide-border">
                {activeSessions.map((session) => (
                  <div key={session.id} className="flex items-center justify-between p-4 hover:bg-muted/30 transition-colors">
                    <div className="flex items-center gap-4">
                      <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${session.status === 'active' ? 'bg-success/10' : 'bg-muted'}`}>
                        <Terminal className={`h-5 w-5 ${session.status === 'active' ? 'text-success' : 'text-muted-foreground'}`} />
                      </div>
                      <div>
                        <div className="flex items-center gap-2">
                          <span className="font-medium">Session {session.id}</span>
                          <Badge variant="outline" className="text-xs">{session.type}</Badge>
                        </div>
                        <div className="flex items-center gap-3 text-sm text-muted-foreground">
                          <span className="font-mono">{session.target}</span>
                          <span>•</span>
                          <span>{session.user}@{session.platform}</span>
                        </div>
                      </div>
                    </div>
                    <div className="flex items-center gap-3">
                      <Badge className={session.status === 'active' ? 'bg-success/20 text-success' : 'bg-muted text-muted-foreground'}>
                        {session.status}
                      </Badge>
                      <Button variant="outline" size="sm" className="gap-1">
                        <Terminal className="h-3 w-3" />
                        Interact
                      </Button>
                    </div>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        </TabsContent>
      </Tabs>

      {/* Exploit Console Dialog */}
      <Dialog open={showConsole} onOpenChange={setShowConsole}>
        <DialogContent className="max-w-4xl h-[80vh] flex flex-col p-0 gap-0">
          <DialogHeader className="p-4 border-b border-border bg-muted/30">
            <DialogTitle className="flex items-center gap-2">
              <Terminal className="h-5 w-5 text-warning" />
              Exploit Execution Console
              {selectedExploit && (
                <Badge variant="outline" className="ml-2 font-mono">{selectedExploit.name}</Badge>
              )}
            </DialogTitle>
            <DialogDescription className="sr-only">
              Interactive exploit execution console with target and payload selection
            </DialogDescription>
          </DialogHeader>

          {/* Target & Payload Selection */}
          <div className="p-4 border-b border-border bg-muted/20 space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="space-y-2">
                <label className="text-sm font-medium flex items-center gap-2">
                  <Server className="h-4 w-4" />
                  Target Host
                </label>
                <Select value={selectedTarget} onValueChange={setSelectedTarget}>
                  <SelectTrigger className="bg-background">
                    <SelectValue placeholder="Select target..." />
                  </SelectTrigger>
                  <SelectContent>
                    {availableTargets.map((target) => (
                      <SelectItem key={target.id} value={target.id.toString()}>
                        <div className="flex items-center gap-2">
                          <span className="font-mono">{target.ip}</span>
                          <span className="text-muted-foreground">({target.hostname})</span>
                          <Badge variant="outline" className="text-xs">{target.os}</Badge>
                        </div>
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
              <div className="space-y-2">
                <label className="text-sm font-medium flex items-center gap-2">
                  <Code className="h-4 w-4" />
                  Payload
                </label>
                <Select value={selectedPayload} onValueChange={setSelectedPayload}>
                  <SelectTrigger className="bg-background">
                    <SelectValue placeholder="Select payload..." />
                  </SelectTrigger>
                  <SelectContent>
                    {payloads.map((payload, index) => (
                      <SelectItem key={index} value={payload.name}>
                        <span className="font-mono">{payload.name}</span>
                      </SelectItem>
                    ))}
                  </SelectContent>
                </Select>
              </div>
            </div>
            <div className="flex items-center gap-2">
              <Button
                onClick={simulateExploit}
                disabled={!selectedTarget || !selectedPayload || isRunning}
                className="gap-2 bg-warning hover:bg-warning/90 text-warning-foreground"
              >
                <Play className="h-4 w-4" />
                Execute Exploit
              </Button>
              {isRunning && (
                <Button variant="destructive" onClick={stopExploit} className="gap-2">
                  <Square className="h-4 w-4" />
                  Stop
                </Button>
              )}
              {isRunning && (
                <div className="flex items-center gap-2 text-warning">
                  <div className="w-2 h-2 bg-warning rounded-full animate-pulse" />
                  <span className="text-sm">Running...</span>
                </div>
              )}
            </div>
          </div>

          {/* Console Output */}
          <ScrollArea className="flex-1 bg-[#0d1117]">
            <div className="p-4 font-mono text-sm space-y-1 min-h-full">
              {consoleOutput.length === 0 ? (
                <div className="text-muted-foreground/50">
                  <p>╔══════════════════════════════════════════════════════════╗</p>
                  <p>║  SecureNet Exploit Framework v6.3.1-dev                  ║</p>
                  <p>║  Select a target and payload, then click Execute         ║</p>
                  <p>╚══════════════════════════════════════════════════════════╝</p>
                  <p className="mt-4">msf6 &gt; _</p>
                </div>
              ) : (
                consoleOutput.map((line, index) => (
                  <div key={index} className={`${getOutputColor(line.type)}`}>
                    {line.text}
                  </div>
                ))
              )}
              <div ref={consoleEndRef} />
            </div>
          </ScrollArea>
        </DialogContent>
      </Dialog>
    </div>
  );
}
